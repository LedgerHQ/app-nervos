
. ./tests/lib.sh

@test "Signing APDU rejects when given garbage to sign and strict checking is enabled." {
  run apdu_fixed "8003c0000400001111"
  [ "$status" -eq 0 ]
  grep -q "<= b''9405" <(echo "$output")
  echo $output
}

# This a self transfer transaction with signing path "m/44'/309'/0'/0/0"

@test "Signing with strict checking and a valid useful transaction passes" {
  run sendTransaction 940500001800000030000000480000004c00000080050000050000002c00008035010080000000800000000000000000050000002c0000803501008000000080000000000000000002000000340500001c000000200000006e0000007200000052040000200500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c561436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d61000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d140000000c000000100000000000000000000000140000000c000000100000000000000000000000
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=21f34fded754e349b5d088c197f7ee091213cfc9e6198639ba5a0359b8952de65500000000000000550000001000000055000000550000004100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "058000002c80000135800000000000000000000000" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

# "Signing a valid transaction: From account 'm/44'/309'/0'/1/1', change 'm/44'/309'/0'/1/1'"
# Transaction:
# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x39641a05511b85d641cc844d0e0e7766983c9a26b1d62d51f251de7125390b16
#       index: 1
# outputs:
#   - capacity: "200.0"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0xf941fd7b5f5ef376561a32d0c5b0bb1cd11802d6
#       hash_type: type
#     type: ~
#   - capacity: "599.998"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x71882946c87d62f9b2f2b5be3be6b5c2704fec59
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x5500000010000000550000005500000041000000469b74c4927b197ae270f68553dec8b900ff400498b78d697b2f94ab8e90a60e1a3182a3ece72f14c9838dd36a98a8871b600a8a5bc3c4ae73ed6cb0c03d1e2700
# hash: 0xfac70fd2f895c64e60db9dd895427209852841e443eb39bbb13d4bc81ac35261

@test "Signing a valid transaction: From account 'm/44'/309'/0'/1/1', change 'm/44'/309'/0'/1/1'" {
  run sendTransaction 260300001800000030000000480000004c0000001a030000050000002c00008035010080000000800100000001000000050000002c0000803501008000000080010000000100000001000000ce0200001c00000020000000490000004d000000ec010000ba020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000009f01000008000000970100000c00000038000000000000000000000039641a05511b85d641cc844d0e0e7766983c9a26b1d62d51f251de7125390b16010000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d9300000000010000000001000000000000000000000039738e9ad7b3ac419a51a9d301cb96722d3e01f2ffbae7779bd31791fc24adad00000000ce0000000c0000006d0000006100000010000000180000006100000000c817a804000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000f941fd7b5f5ef376561a32d0c5b0bb1cd11802d66100000010000000180000006100000060995da012000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000071882946c87d62f9b2f2b5be3be6b5c2704fec59140000000c000000100000000000000000000000ce0000000c0000006d0000006100000010000000180000006100000000c817a804000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000f941fd7b5f5ef376561a32d0c5b0bb1cd11802d661000000100000001800000061000000c04a44f80d000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000071882946c87d62f9b2f2b5be3be6b5c2704fec59140000000c0000001000000000000000000000000c0000000800000000000000
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=fac70fd2f895c64e60db9dd895427209852841e443eb39bbb13d4bc81ac35261550000000000000055000000100000005500000055000000410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "058000002c80000135800000000000000100000001" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

@test "Signing an invalid transaction (wrong change_path) should fail: From account 'm/44'/309'/0/1/1'', change 'm/44'/309'/0'/1/1'" {
  run sendTransaction 260300001800000030000000480000004c0000001a030000050000002c00008035010080000000800100000001000000050000002c0000803501008000000080010000000200000001000000ce0200001c00000020000000490000004d000000ec010000ba020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000009f01000008000000970100000c00000038000000000000000000000039641a05511b85d641cc844d0e0e7766983c9a26b1d62d51f251de7125390b16010000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d9300000000010000000001000000000000000000000039738e9ad7b3ac419a51a9d301cb96722d3e01f2ffbae7779bd31791fc24adad00000000ce0000000c0000006d0000006100000010000000180000006100000000c817a804000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000f941fd7b5f5ef376561a32d0c5b0bb1cd11802d66100000010000000180000006100000060995da012000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000071882946c87d62f9b2f2b5be3be6b5c2704fec59140000000c000000100000000000000000000000ce0000000c0000006d0000006100000010000000180000006100000000c817a804000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000f941fd7b5f5ef376561a32d0c5b0bb1cd11802d661000000100000001800000061000000c04a44f80d000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000071882946c87d62f9b2f2b5be3be6b5c2704fec59140000000c0000001000000000000000000000000c0000000800000000000000 --expectReject
  grep -q "<= b''6982" <(echo "$output")
}

# "Signing a valid self transfer transaction"
# Created using this command
# wallet transfer --from-account 0x8d5520741f06a062543cdea9a21fc20d07ee29b0 --to-address ckt1qyqqtw74sngmqqqzauwulk6e3rc0l46gmuxqptn8pr --capacity 3750 --tx-fee 0.001  --derive-change-address ckt1qyqqtw74sngmqqqzauwulk6e3rc0l46gmuxqptn8pr  --derive-receiving-address-length 3 --derive-change-address-length 3

# Transaction 
# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x2e4f4999bc2ae5d1bf1964d1fb4fa2d7c9dff014faa0fb4130fcaf053a828b6b
#       index: 0
# outputs:
#   - capacity: "3750.0"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x05bbd584d1b00002ef1dcfdb5988f0ffd748df0c
#       hash_type: type
#     type: ~
#   - capacity: "2249.999"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x05bbd584d1b00002ef1dcfdb5988f0ffd748df0c
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x5500000010000000550000005500000041000000323da15393fc3aaf7be44436fbad50d1b663d99d4f387e61eec7054828aab2b272664dab2b9cbaf07dbeccf38746669ae8d27a3a8ffc60e3d891366ffeee218901
# hash: 0x32e63801a2a67840be36a31f42056e6f4ef0400548e39cc0311bcd93d648f976

@test "Signing a valid self transfer transaction" {
  run sendTransaction 260300001800000030000000480000004c0000001a030000050000002c00008035010080000000800000000003000000050000002c0000803501008000000080000000000300000001000000ce0200001c00000020000000490000004d000000ec010000ba020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000009f01000008000000970100000c0000003800000000000000000000002e4f4999bc2ae5d1bf1964d1fb4fa2d7c9dff014faa0fb4130fcaf053a828b6b000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000000100000000000000000000004f26933c260b39c605b4fe848f506459d97f3f7a3b4c1a3de80b026dd7a3111401000000ce0000000c0000006d000000610000001000000018000000610000000070c9b28b000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000005bbd584d1b00002ef1dcfdb5988f0ffd748df0c610000001000000018000000610000006003d7c0166bc11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c000000100000000000000000000000ce0000000c0000006d0000006100000010000000180000006100000000e6bd4f57000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000005bbd584d1b00002ef1dcfdb5988f0ffd748df0c6100000010000000180000006100000060030a6334000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000005bbd584d1b00002ef1dcfdb5988f0ffd748df0c140000000c0000001000000000000000000000000c0000000800000000000000
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=32e63801a2a67840be36a31f42056e6f4ef0400548e39cc0311bcd93d648f976550000000000000055000000100000005500000055000000410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "058000002c80000135800000000000000000000003" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

# "Signing a valid transaction: From account 'm/44'/309'/0'/0/2', and same change path"
# From and change address are same
# wallet transfer --from-account 0x8d5520741f06a062543cdea9a21fc20d07ee29b0 --to-address ckt1qyq2yksyd5g6jkumltkrx35qvz6hdlypatlsz7agpy --capacity 1560 --tx-fee 0.001  --derive-change-address  ckt1qyqxt33570n599su3f88zxg38zn3ae00jkgsawek56 --derive-receiving-address-length 2 --derive-change-address-length 2

# Transaction 
# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x4f26933c260b39c605b4fe848f506459d97f3f7a3b4c1a3de80b026dd7a31114
#       index: 0
# outputs:
#   - capacity: "1560.0"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0xa25a046d11a95b9bfaec33468060b576fc81eaff
#       hash_type: type
#     type: ~
#   - capacity: "439.999"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x65c634f3e742961c8a4e71191138a71ee5ef9591
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x5500000010000000550000005500000041000000b8f6b3ba613906b354dafa9423af8c534141c20fa343e3ef3c7054729b7b14ff4b2510b774d9ededc299e5181b5ff8acf8bc6c874c99b544ca513b52b87d5f7400
# hash: 0x23901dc31e18374f9a088f0033dcca6122f4e3646808c2e8b25983c4807e66b7

@test "Signing a valid transaction: From account 'm/44'/309'/0'/0/2', and same change path" {
  run sendTransaction 260300001800000030000000480000004c0000001a030000050000002c00008035010080000000800000000002000000050000002c0000803501008000000080000000000200000001000000ce0200001c00000020000000490000004d000000ec010000ba020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000009f01000008000000970100000c0000003800000000000000000000004f26933c260b39c605b4fe848f506459d97f3f7a3b4c1a3de80b026dd7a31114000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93000000000100000000010000000000000000000000be3abd7565dd5e106a454368d7acec71c7a5114121d9dfe07ad54c48434f615c01000000ce0000000c0000006d0000006100000010000000180000006100000000d0ed902e000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000065c634f3e742961c8a4e71191138a71ee5ef95916100000010000000180000006100000000faa173a26bc11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c000000100000000000000000000000ce0000000c0000006d000000610000001000000018000000610000000018535224000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000a25a046d11a95b9bfaec33468060b576fc81eaff610000001000000018000000610000006031993e0a000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000065c634f3e742961c8a4e71191138a71ee5ef9591140000000c0000001000000000000000000000000c0000000800000000000000
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=23901dc31e18374f9a088f0033dcca6122f4e3646808c2e8b25983c4807e66b7550000000000000055000000100000005500000055000000410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "058000002c80000135800000000000000000000002" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

@test "Signing an invalid transaction (wrong change_path) should fail: From account 'm/44'/309'/0'/0/2', and same change path" {
  run sendTransaction 260300001800000030000000480000004c0000001a030000050000002c00008035010080000000800000000002000000050000002c0000803501008000000080000000000300000001000000ce0200001c00000020000000490000004d000000ec010000ba020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000009f01000008000000970100000c0000003800000000000000000000004f26933c260b39c605b4fe848f506459d97f3f7a3b4c1a3de80b026dd7a31114000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93000000000100000000010000000000000000000000be3abd7565dd5e106a454368d7acec71c7a5114121d9dfe07ad54c48434f615c01000000ce0000000c0000006d0000006100000010000000180000006100000000d0ed902e000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000065c634f3e742961c8a4e71191138a71ee5ef95916100000010000000180000006100000000faa173a26bc11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c000000100000000000000000000000ce0000000c0000006d000000610000001000000018000000610000000018535224000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000a25a046d11a95b9bfaec33468060b576fc81eaff610000001000000018000000610000006031993e0a000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000065c634f3e742961c8a4e71191138a71ee5ef9591140000000c0000001000000000000000000000000c0000000800000000000000 --expectReject
  grep -q "<= b''6982" <(echo "$output")
}

# "Signing a valid transaction: From account 'm/44'/309'/0'/0/4', and change path 'm/44'/309'/0'/1/5'"
# wallet transfer --from-account 0x8d5520741f06a062543cdea9a21fc20d07ee29b0 --to-address ckt1qyq8rzpfgmy86chektett03mu66uyuz0a3vskk4eel --capacity 1400 --tx-fee 0.001  --derive-change-address ckt1qyqxyt6gphlcwvw3tjpj6g35ae8da5x0uwvqrprflz  --derive-receiving-address-length 4 --derive-change-address-length 5

# Transaction
# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0xf44b26dda9f1f48b20029654be67c2e636b7fec62b877e20b695c2307dae4a52
#       index: 0
# outputs:
#   - capacity: "1400.0"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x71882946c87d62f9b2f2b5be3be6b5c2704fec59
#       hash_type: type
#     type: ~
#   - capacity: "99.999"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x622f480dff8731d15c832d2234ee4eded0cfe398
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x550000001000000055000000550000004100000097e3118c185ead9ca04f85380fba25b796ef849a01a321a13e921c725a85b8e772eab6ce0ab4982b38a895026ed09a2f634c4aca3849e288099921b72566657e01
# hash: 0x4dbfe46d45f2330a661ec7bbf439aa5ba2cf6a39149ba1c85c47963e706837d6

@test "Signing a valid transaction: From account 'm/44'/309'/0'/0/4', and change path 'm/44'/309'/0'/1/5'" {
  run sendTransaction 260300001800000030000000480000004c0000001a030000050000002c00008035010080000000800000000004000000050000002c0000803501008000000080010000000500000001000000ce0200001c00000020000000490000004d000000ec010000ba020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000009f01000008000000970100000c000000380000000000000000000000f44b26dda9f1f48b20029654be67c2e636b7fec62b877e20b695c2307dae4a52000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000000100000000000000000000002e4f4999bc2ae5d1bf1964d1fb4fa2d7c9dff014faa0fb4130fcaf053a828b6b01000000ce0000000c0000006d00000061000000100000001800000061000000005cb2ec22000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000004c73d21a2cd6501255bf410dcab0265c2ee1fdcb61000000100000001800000061000000c02023d4f36ac11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c000000100000000000000000000000ce0000000c0000006d000000610000001000000018000000610000000078a69820000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000071882946c87d62f9b2f2b5be3be6b5c2704fec5961000000100000001800000061000000605d0a5402000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000622f480dff8731d15c832d2234ee4eded0cfe398140000000c0000001000000000000000000000000c0000000800000000000000
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=4dbfe46d45f2330a661ec7bbf439aa5ba2cf6a39149ba1c85c47963e706837d6550000000000000055000000100000005500000055000000410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "058000002c80000135800000000000000000000004" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

# "Signing a valid transaction to multisig address passes (has two inputs)"
# This transaction has two input cells belonging to the same lock_arg (root account)

# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x3772e5f47d00993b8db0da7685ac27902c399ba6961275b8c7f8cd1286a3d1d6
#       index: 1
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x21ea7484a585b81222114e36e4b6bb1d2026a0d7db5a1985727fe5d8ae264fcb
#       index: 0
# outputs:
#   - capacity: "900.0"
#     lock:
#       code_hash: 0x5c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a8 (multisig)
#       args: 0xf901ee8ced14138f36c4b597154bd43583925c57
#       hash_type: type
#     type: ~
#   - capacity: "199.998"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x8d5520741f06a062543cdea9a21fc20d07ee29b0
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x550000001000000055000000550000004100000040c58c35091b5e9d713f2a556834438a34d210fa7dea14a16543ff2cee086dd34202c60b7d7ea7b0a7651244005c3a293467261a3b26a5927ce2813e011049701
#   - 0x
# hash: 0x276d5447f20df863b13bcafd63de2ad851e4f35eda337268b19ab0cf7c29c608

@test "Signing a valid transaction to multisig address passes (contains two inputs)" {
  run sendTransaction b90400001800000028000000380000003c000000a5040000030000002c0000803501008000000080030000002c000080350100800000008002000000690400001c00000020000000490000004d0000008703000055040000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000003a0300000c000000a3010000970100000c0000003800000000000000000000003772e5f47d00993b8db0da7685ac27902c399ba6961275b8c7f8cd1286a3d1d6010000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93000000000100000000010000000000000000000000be3abd7565dd5e106a454368d7acec71c7a5114121d9dfe07ad54c48434f615c00000000ce0000000c0000006d0000006100000010000000180000006100000000046bf414000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8011400000071882946c87d62f9b2f2b5be3be6b5c2704fec5961000000100000001800000061000000605d0a5402000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000008d5520741f06a062543cdea9a21fc20d07ee29b0140000000c000000100000000000000000000000970100000c00000038000000000000000000000021ea7484a585b81222114e36e4b6bb1d2026a0d7db5a1985727fe5d8ae264fcb000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d9300000000010000000001000000000000000000000013b9eda5f8a22a510f3a7fda74f5a4c0e0396dba1d328ecaa40925fd12d9b37401000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000008d5520741f06a062543cdea9a21fc20d07ee29b06100000010000000180000006100000050fe43b2966ac11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c000000100000000000000000000000ce0000000c0000006d0000006100000010000000180000006100000000046bf414000000490000001000000030000000310000005c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a80114000000f901ee8ced14138f36c4b597154bd43583925c5761000000100000001800000061000000c0ba14a804000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000008d5520741f06a062543cdea9a21fc20d07ee29b0140000000c000000100000000000000000000000140000000c000000100000000000000000000000
  promptsCheck 4 tests/sign-valid-tx-3-prompts.txt
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=276d5447f20df863b13bcafd63de2ad851e4f35eda337268b19ab0cf7c29c6085500000000000000550000001000000055000000550000004100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "038000002c8000013580000000" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}


# "Signing a valid transaction to multisig timelock address passes"
# util to-multisig-addr --sighash-address ckt1qyqg64fqws0sdgrz2s7da2dzrlpq6plw9xcq2e8e5l --locktime "2020-06-30T00:00:00+00:00"
# address:
#   mainnet: ckb1q3w9q60tppt7l3j7r09qcp7lxnp3vcanvgha8pmvsa3jplykxn323x9vd6ppzz5775yjxd6mlh977m7e0xu2ccqqqquqgzq8yqvzdv4v
#   testnet: ckt1q3w9q60tppt7l3j7r09qcp7lxnp3vcanvgha8pmvsa3jplykxn323x9vd6ppzz5775yjxd6mlh977m7e0xu2ccqqqquqgzq8yqrav43u
# target_epoch: "Epoch { number: 96, index: 1080, length: 1800 }"

# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x276d5447f20df863b13bcafd63de2ad851e4f35eda337268b19ab0cf7c29c608
#       index: 1
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x40e54fc2d1aabbd39ae6cd8a5df922995dd856f24f670d3d5f283690a534a544
#       index: 0
# outputs:
#   - capacity: "300.0"
#     lock:
#       code_hash: 0x5c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a8 (multisig)
#       args: 0x98ac6e82110a9ef50923375bfdcbef6fd979b8ac6000003804080720
#       hash_type: type
#     type: ~
#   - capacity: "899.997"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0x8d5520741f06a062543cdea9a21fc20d07ee29b0
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x5500000010000000550000005500000041000000ad2eee29bd91556d68b6313ea8957cf2ae3eb8266241897147486f4a6464171615855e59af5a763a82296886d3c22628fc1aed94e55b1ee050661618c588144c00
#   - 0x
# hash: 0x6127c3e68295fb18d6ed55256f5ac3bb81c3446c671ff029db7ad7992bc7b394

@test "Signing a valid transaction to multisig timelock address passes" {
  run sendTransaction ed0400001800000028000000380000003c000000d9040000030000002c0000803501008000000080030000002c0000803501008000000080020000009d0400001c00000020000000490000004d000000b303000089040000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93000000000100000000660300000c000000cf010000c30100000c000000380000000000000000000000276d5447f20df863b13bcafd63de2ad851e4f35eda337268b19ab0cf7c29c608010000008b0100001c00000020000000490000004d000000a900000077010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930000000001000000000200000000000000000000003772e5f47d00993b8db0da7685ac27902c399ba6961275b8c7f8cd1286a3d1d601000000000000000000000021ea7484a585b81222114e36e4b6bb1d2026a0d7db5a1985727fe5d8ae264fcb00000000ce0000000c0000006d0000006100000010000000180000006100000000046bf414000000490000001000000030000000310000005c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a80114000000f901ee8ced14138f36c4b597154bd43583925c5761000000100000001800000061000000c0ba14a804000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000008d5520741f06a062543cdea9a21fc20d07ee29b0140000000c000000100000000000000000000000970100000c00000038000000000000000000000040e54fc2d1aabbd39ae6cd8a5df922995dd856f24f670d3d5f283690a534a544000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d9300000000010000000001000000000000000000000021ea7484a585b81222114e36e4b6bb1d2026a0d7db5a1985727fe5d8ae264fcb01000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000008d5520741f06a062543cdea9a21fc20d07ee29b061000000100000001800000061000000b08fcb697f6ac11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c000000100000000000000000000000d60000000c000000750000006900000010000000180000006900000000ac23fc06000000510000001000000030000000310000005c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a8011c00000098ac6e82110a9ef50923375bfdcbef6fd979b8ac600000380408072061000000100000001800000061000000207066f414000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce801140000008d5520741f06a062543cdea9a21fc20d07ee29b0140000000c000000100000000000000000000000140000000c000000100000000000000000000000
  promptsCheck 4 tests/sign-valid-tx-4-prompts.txt
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=6127c3e68295fb18d6ed55256f5ac3bb81c3446c671ff029db7ad7992bc7b3945500000000000000550000001000000055000000550000004100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "038000002c8000013580000000" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}


# "Signing a valid multisig transaction passes"
# Simple multisig transaction with input address created via
# tx build-multisig-address --sighash-address ckt1qyqg64fqws0sdgrz2s7da2dzrlpq6plw9xcq2e8e5l ckt1qyqwggd90hnw6kqp39rrzvwvkm2cg0dtjawspc6k35 --threshold 2

# # Transaction json
# {
#   "transaction": {
#     "version": "0x0",
#     "cell_deps": [
#       {
#         "out_point": {
#           "tx_hash": "0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93",
#           "index": "0x1"
#         },
#         "dep_type": "dep_group"
#       }
#     ],
#     "header_deps": [],
#     "inputs": [
#       {
#         "since": "0x0",
#         "previous_output": {
#           "tx_hash": "0x4a533a3a693d25bdd3d2cebfcdcf9a9b664d89a6e75baadcaae2c475078e6525",
#           "index": "0x0"
#         }
#       }
#     ],
#     "outputs": [
#       {
#         "capacity": "0xba439ed60",
#         "lock": {
#           "code_hash": "0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8",
#           "hash_type": "type",
#           "args": "0xc0dca02acbaac6fc4a29a23da6fc3d415655c55d"
#         },
#         "type": null
#       }
#     ],
#     "outputs_data": [
#       "0x"
#     ],
#     "witnesses": []
#   },
#   "multisig_configs": {
#     "0xe6bc2c807bdb45ec3eb22aafe290808757b41f75": {
#       "sighash_addresses": [
#         "ckt1qyqg64fqws0sdgrz2s7da2dzrlpq6plw9xcq2e8e5l",
#         "ckt1qyqwggd90hnw6kqp39rrzvwvkm2cg0dtjawspc6k35"
#       ],
#       "require_first_n": 0,
#       "threshold": 1
#     },
#     "0xf901ee8ced14138f36c4b597154bd43583925c57": {
#       "sighash_addresses": [
#         "ckt1qyqg64fqws0sdgrz2s7da2dzrlpq6plw9xcq2e8e5l",
#         "ckt1qyqwggd90hnw6kqp39rrzvwvkm2cg0dtjawspc6k35"
#       ],
#       "require_first_n": 0,
#       "threshold": 2
#     }
#   },
#   "signatures": {
#     "0xf901ee8ced14138f36c4b597154bd43583925c57": [
#       "0x046e1a9111a588b9834a79277ba0621f1e668d8f41bdcdf1f28ee2449fd077ba433141478c2e32e40ecb471ffc5182b657763cf770e618d510f298f0b42d70a601",
#       "0xf93ad0b88cccaa85f6168c283244b0ee7d63d1a65088873be8d9c29b636bbc2e4decb26671772ada40c5c3fe6751c8456eb2945676a2e730719c332d216f8a6001"
#     ]
#   }
# }? 

# Input transaction
# version: 0
# cell_deps:
#   - out_point:
#       tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#       index: 0
#     dep_type: dep_group
# header_deps: []
# inputs:
#   - since: 0x0 (absolute block(0))
#     previous_output:
#       tx_hash: 0x80e736727ac08e31741f33359850a2fa1ed8e082908c1fbb02cf9d9133cee566
#       index: 1
# outputs:
#   - capacity: "500.0"
#     lock:
#       code_hash: 0x5c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a8 (multisig)
#       args: 0xf901ee8ced14138f36c4b597154bd43583925c57
#       hash_type: type
#     type: ~
#   - capacity: "19999971049.9777"
#     lock:
#       code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#       args: 0xcc4e78b857b8ea477304925ac0f67b7348b86761
#       hash_type: type
#     type: ~
# outputs_data:
#   - 0x
#   - 0x
# witnesses:
#   - 0x5500000010000000550000005500000041000000c01b9e3e12330b4a591e3e670f51fcaaee8b7bda70d7806e3ce74bb94bb809553cfe0e60dcb897e26828ba835c796dfeb87b7d33b01a57e3933c7b48fc91f89101
# hash: 0x4a533a3a693d25bdd3d2cebfcdcf9a9b664d89a6e75baadcaae2c475078e6525

@test "Signing a valid multisig transaction passes" {
  run sendTransaction 6b0300001800000028000000380000003c0000009d020000030000002c0000803501008000000080030000002c000080350100800000008001000000610200001c00000020000000490000004d000000ec01000055020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930100000001000000009f01000008000000970100000c0000003800000000000000000000004a533a3a693d25bdd3d2cebfcdcf9a9b664d89a6e75baadcaae2c475078e6525000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d9300000000010000000001000000000000000000000080e736727ac08e31741f33359850a2fa1ed8e082908c1fbb02cf9d9133cee56601000000ce0000000c0000006d0000006100000010000000180000006100000000743ba40b000000490000001000000030000000310000005c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a80114000000f901ee8ced14138f36c4b597154bd43583925c576100000010000000180000006100000010a33343c56ac11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c00000010000000000000000000000069000000080000006100000010000000180000006100000060ed39a40b000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000c0dca02acbaac6fc4a29a23da6fc3d415655c55d0c0000000800000000000000ce00000008000000c2000000c200000010000000c2000000c2000000ae000000000002028d5520741f06a062543cdea9a21fc20d07ee29b0e421a57de6ed580189463131ccb6d5843dab975d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  promptsCheck 4 tests/sign-valid-multisig-tx-1-prompts.txt
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=7feeb9b128baac6700e57d5cd48f3697b777888e270dd6f96887c15da7d99215c200000000000000c200000010000000c2000000c2000000ae000000000002028d5520741f06a062543cdea9a21fc20d07ee29b0e421a57de6ed580189463131ccb6d5843dab975d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "038000002c8000013580000000" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

# "Signing a valid multisig transaction passes (2)"
# Contains a multisig input address with 13 pubkeys

# transaction:
#   version: 0
#   cell_deps:
#     - out_point:
#         tx_hash: 0x01ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d93
#         index: 1
#       dep_type: dep_group
#   header_deps: []
#   inputs:
#     - since: 0x0 (absolute block(0))
#       previous_output:
#         tx_hash: 0xe52f7a2c51a88db162abade844ecba29c64f7e1b50c8ee30ac4240095bf3a9c3
#         index: 0
#   outputs:
#     - capacity: "1799.999"
#       lock:
#         code_hash: 0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8 (sighash)
#         args: 0xcc4e78b857b8ea477304925ac0f67b7348b86761
#         hash_type: type
#       type: ~
#   outputs_data:
#     - 0x
#   witnesses:
#     - 0x9e010000100000009e0100009e0100008a0100000000020d8d5520741f06a062543cdea9a21fc20d07ee29b0e421a57de6ed580189463131ccb6d5843dab975dcc4e78b857b8ea477304925ac0f67b7348b867619c8ce01eaf3910b8b18c32a4fec37f3d35f84041e5260d839a786ac2a909181df9a423f1efbe863da25a046d11a95b9bfaec33468060b576fc81eaff83462eafd93f0a598ab26597e5cda6523b2fc15371882946c87d62f9b2f2b5be3be6b5c2704fec5965c634f3e742961c8a4e71191138a71ee5ef95910320d01cac0c3ca512069f6909196675cd4deab905bbd584d1b00002ef1dcfdb5988f0ffd748df0c4c73d21a2cd6501255bf410dcab0265c2ee1fdcb622f480dff8731d15c832d2234ee4eded0cfe398b10c4a2a3835d34d1c7c141eea6d9bb924b7d58edcd7059e3499a4aaf951ada85cc0813178f9ed4faa29c3b36e6e31db917705323b55e144c02a8584fe1eb411009b36732f8035a5aee8e16aa32c9b0ba1c576b8820ab07d80fcfcc382662f31a965c47e7ad7d20422b8779e81c6ebd52aa067ea58aca136c0866f37cac2ebf62b00
#   hash: 0xaad41c6b2fb1943c9330e98c9c8f31244787403938d28dc19743b6b1773efe1e

@test "Signing a valid multisig transaction passes (2)" {
  run sendTransaction 470400001800000028000000380000003c0000009d020000030000002c0000803501008000000080030000002c000080350100800000008001000000610200001c00000020000000490000004d000000ec01000055020000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d930100000001000000009f01000008000000970100000c000000380000000000000000000000e52f7a2c51a88db162abade844ecba29c64f7e1b50c8ee30ac4240095bf3a9c3000000005f0100001c00000020000000490000004d0000007d0000004b010000000000000100000001ef8910ef4e71349763523a077eea304b0e852c45b04d5b56c482306f4f6d9300000000010000000001000000000000000000000040e54fc2d1aabbd39ae6cd8a5df922995dd856f24f670d3d5f283690a534a54401000000ce0000000c0000006d000000610000001000000018000000610000000008d6e829000000490000001000000030000000310000005c5069eb0857efc65e1bca0c07df34c31663b3622fd3876c876320fc9634e2a801140000009cd462f96bd34a61e0a553e57efd2ba3414a561061000000100000001800000061000000a060f580556ac11b490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b86761140000000c0000001000000000000000000000006900000008000000610000001000000018000000610000006081d4e829000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000cc4e78b857b8ea477304925ac0f67b7348b867610c0000000800000000000000aa010000080000009e0100009e010000100000009e0100009e0100008a0100000000020d8d5520741f06a062543cdea9a21fc20d07ee29b0e421a57de6ed580189463131ccb6d5843dab975dcc4e78b857b8ea477304925ac0f67b7348b867619c8ce01eaf3910b8b18c32a4fec37f3d35f84041e5260d839a786ac2a909181df9a423f1efbe863da25a046d11a95b9bfaec33468060b576fc81eaff83462eafd93f0a598ab26597e5cda6523b2fc15371882946c87d62f9b2f2b5be3be6b5c2704fec5965c634f3e742961c8a4e71191138a71ee5ef95910320d01cac0c3ca512069f6909196675cd4deab905bbd584d1b00002ef1dcfdb5988f0ffd748df0c4c73d21a2cd6501255bf410dcab0265c2ee1fdcb622f480dff8731d15c832d2234ee4eded0cfe39800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  promptsCheck 4 tests/sign-valid-multisig-tx-2-prompts.txt
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=aad41c6b2fb1943c9330e98c9c8f31244787403938d28dc19743b6b1773efe1e9e010000000000009e010000100000009e0100009e0100008a0100000000020d8d5520741f06a062543cdea9a21fc20d07ee29b0e421a57de6ed580189463131ccb6d5843dab975dcc4e78b857b8ea477304925ac0f67b7348b867619c8ce01eaf3910b8b18c32a4fec37f3d35f84041e5260d839a786ac2a909181df9a423f1efbe863da25a046d11a95b9bfaec33468060b576fc81eaff83462eafd93f0a598ab26597e5cda6523b2fc15371882946c87d62f9b2f2b5be3be6b5c2704fec5965c634f3e742961c8a4e71191138a71ee5ef95910320d01cac0c3ca512069f6909196675cd4deab905bbd584d1b00002ef1dcfdb5988f0ffd748df0c4c73d21a2cd6501255bf410dcab0265c2ee1fdcb622f480dff8731d15c832d2234ee4eded0cfe39800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "038000002c8000013580000000" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

@test "Signing with strict checking and an incorrect context fails" {
  run apdu_fixed "8003400011048000002c800001358000000080000000"
  [ "$status" -eq 0 ]
  grep -q "<= b''9000" <(echo "$output")

  run sendTransaction "940500001800000030000000480000004c00000080050000050000002c00008035010080000000800000000000000000050000002c0000803501008000000080000000000000000002000000340500001c000000200000006e0000007200000052040000200500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c661436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d61000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d140000000c000000100000000000000000000000140000000c000000100000000000000000000000" --expectReject
  grep -q "<= b''9405" <(echo "$output")
  hardRejectionMessageCheck "Context transaction does not match hash"
}

@test "Signing with strict checking of a transaction having a type script fails" {
  run apdu_fixed "8003400011048000002c800001358000000080000000"
  [ "$status" -eq 0 ]
  grep -q "<= b''9000" <(echo "$output")
  run sendTransaction d10500001800000030000000480000004c000000bd050000050000002c00008035010080000000800000000000000000050000002c0000803501008000000080000000000000000002000000710500001c000000200000006e0000007200000052040000550500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c561436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000083d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e010000000061000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c0000001800000008000000000000000000000000000000140000000c000000100000000000000000000000 --expectReject
  grep -q "<= b''6982" <(echo "$output")
  rejectionMessageCheck "Only the DAO type script is supported" 2
}

# @test "Signing with a transaction having a type script outside of strict checking prompts with a hash" {
#   # Turn on the Sign Hash opt
#   clicks "rRrRlrLRrRlrLRrRrlRL"
#   run apdu_fixed "8003400011048000002c800001358000000080000000"
#   [ "$status" -eq 0 ]
#   grep -q "<= b''9000" <(echo "$output")
#   run sendTransaction d10500001800000030000000480000004c000000bd050000050000002c00008035010080000000800000000000000000050000002c0000803501008000000080000000000000000002000000710500001c000000200000006e0000007200000052040000550500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c561436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000083d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e010000000061000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c0000001800000008000000000000000000000000000000140000000c000000100000000000000000000000 --no-hard-check
#   promptsCheck 2 tests/sign-unsafe-prompts.txt
# }

# AnnotatedTransaction {
# signPath: Bip32 [Uint32(0x2c000080), Uint32(0x35010080), Uint32(0x00000080), Uint32(0x00000000), Uint32(0x00000000)],
# changePath: Bip32 [Uint32(0x2c000080), Uint32(0x35010080), Uint32(0x01000080), Uint32(0x01000080)],
# inputCount: Uint32(0x02000000),
# raw: AnnotatedRawTransaction {
# version: Uint32(0x00000000),
# cell_deps: CellDepVec [CellDep { out_point: OutPoint { tx_hash: Byte32(0xa563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc541), index: Uint32(0x02000000) }, dep_type: Byte(0x00) }, CellDep { out_point: OutPoint { tx_hash: Byte32(0xace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708), index: Uint32(0x00000000) }, dep_type: Byte(0x01) }],
# header_deps: Byte32Vec [],
# inputs: AnnotatedCellInputVec [AnnotatedCellInput { input: CellInput { since: Uint64(0x0000000000000000), previous_output: OutPoint { tx_hash: Byte32(0xb1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5), index: Uint32(0x01000000) } }, source: RawTransaction { version: Uint32(0x00000000), cell_deps: CellDepVec [CellDep { out_point: OutPoint { tx_hash: Byte32(0xa563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc541), index: Uint32(0x02000000) }, dep_type: Byte(0x00) }, CellDep { out_point: OutPoint { tx_hash: Byte32(0xace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708), index: Uint32(0x00000000) }, dep_type: Byte(0x01) }], header_deps: Byte32Vec [Byte32(0x327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb)], inputs: CellInputVec [CellInput { since: Uint64(0x0000000000000000), previous_output: OutPoint { tx_hash: Byte32(0xc399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307), index: Uint32(0x00000000) } }, CellInput { since: Uint64(0x0000000000000000), previous_output: OutPoint { tx_hash: Byte32(0xc317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a5), index: Uint32(0x01000000) } }], outputs: CellOutputVec [CellOutput { capacity: Uint64(0x00e8764817000000), lock: Script { code_hash: Byte32(0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8), hash_type: Byte(0x01), args: Bytes(0xe5260d839a786ac2a909181df9a423f1efbe863d) }, type_: ScriptOpt(Some(Script { code_hash: Byte32(0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e), hash_type: Byte(0x01), args: Bytes(0x) })) }, CellOutput { capacity: Uint64(0x64e5b27317000000), lock: Script { code_hash: Byte32(0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8), hash_type: Byte(0x01), args: Bytes(0xe5260d839a786ac2a909181df9a423f1efbe863d) }, type_: ScriptOpt(None) }], outputs_data: BytesVec [Bytes(0x5207000000000000), Bytes(0x)] } },
# AnnotatedCellInput { input: CellInput { since: Uint64(0x0000000000000000), previous_output: OutPoint { tx_hash: Byte32(0x258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a9), index: Uint32(0x00000000) } }, source: RawTransaction { version: Uint32(0x00000000), cell_deps: CellDepVec [CellDep { out_point: OutPoint { tx_hash: Byte32(0xa563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc541), index: Uint32(0x02000000) }, dep_type: Byte(0x00) }, CellDep { out_point: OutPoint { tx_hash: Byte32(0xace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708), index: Uint32(0x00000000) }, dep_type: Byte(0x01) }], header_deps: Byte32Vec [Byte32(0x327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb), Byte32(0x4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca)], inputs: CellInputVec [CellInput { since: Uint64(0xba08000000010020), previous_output: OutPoint { tx_hash: Byte32(0xb1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5), index: Uint32(0x00000000) } }], outputs: CellOutputVec [CellOutput { capacity: Uint64(0xc561436317000000), lock: Script { code_hash: Byte32(0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8), hash_type: Byte(0x01), args: Bytes(0xe5260d839a786ac2a909181df9a423f1efbe863d) }, type_: ScriptOpt(None) }], outputs_data: BytesVec [Bytes(0x)] } }],
# outputs: CellOutputVec [CellOutput { capacity: Uint64(0x00e8764817000000), lock: Script { code_hash: Byte32(0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8), hash_type: Byte(0x01), args: Bytes(0xe5260d839a786ac2a909181df9a423f1efbe863d) }, type_: ScriptOpt(None) }, CellOutput { capacity: Uint64(0xe91c708e17000000), lock: Script { code_hash: Byte32(0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8), hash_type: Byte(0x01), args: Bytes(0xb690f63b6fca7abff77c558bffa7401ec40dcb52) }, type_: ScriptOpt(None) }],
# outputs_data: BytesVec [Bytes(0x), Bytes(0x)] },
# witnesses: BytesVec [Bytes(0x), Bytes(0x)]
# }

@test "Signing with strict checking and a different change address passes." {

  run sendTransaction 90050000180000003000000044000000480000007c050000050000002c00008035010080000000800000000000000000040000002c00008035010080010000800100008002000000340500001c000000200000006e0000007200000052040000200500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c561436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d61000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000b690f63b6fca7abff77c558bffa7401ec40dcb52140000000c000000100000000000000000000000140000000c000000100000000000000000000000
  promptsCheck 4 tests/sign-with-change-path.txt
  rv="$(egrep "<= b'.*'9000" <(echo "$output")|cut -d"'" -f2)"
  txhash_and_witness=56aa7721f93350b942333b389fbdf062d5a5ad86cabe7cb20f7c00bab2d09baf5500000000000000550000001000000055000000550000004100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
  run check_signature "058000002c80000135800000000000000000000000" "$txhash_and_witness" "$rv"
  diff <(echo $output) - <<<"Signature Verified Successfully"
}

@test "Signing with strict checking, a plain transfer, and data in an output cell fails" {
  run sendTransaction 980500001800000030000000480000004c00000084050000050000002c0000803501008000000080000000000000000005000000001c000000200000006e000000b2000000e2000002000000380500001c000000200000006e0000007200000052040000200500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c561436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d61000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d180000000c0000001400000004000000deadbeef00000000140000000c000000100000000000000000000000 --expectReject
  [ "$status" -eq 0 ]
  grep -q "<= b''6982" <(echo "$output")
  rejectionMessageCheck "Data found in non-dao cell"
}

@test "Signing with strict checking, a plain transfer, and data in an output cell fails even with eight bytes of data" {
  run sendTransaction 9c0500001800000030000000480000004c00000088050000050000002c000080350100800000008000000000000000000500000001c4000001b80000001c000000200000006e0000020000003c0500001c000000200000006e0000007200000052040000200500000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000100000000e00300000c00000051020000450200000c000000380000000000000000000000b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d5010000000d0200001c000000200000006e00000092000000ee000000f10100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000101000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb020000000000000000000000c399495011b912999dbc72cf54982924e328ae170654ef76c8aba190ca376307000000000000000000000000c317d0b0b2a513ab1206e6d454c1960de7d7b4b80d0748a3e1f9cb197b74b8a501000000030100000c000000a20000009600000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d3500000010000000300000003100000082d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e01000000006100000010000000180000006100000064e5b27317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c00000018000000080000005207000000000000000000008f0100000c000000380000000000000000000000258e82bab2af21fd8899fc872742f4acea831f5e4c232297816b9bf4a19597a900000000570100001c000000200000006e000000b2000000e20000004b0100000000000002000000a563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc5410200000000ace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708000000000102000000327f1fc62c53530c6c27018f1e8cee27c35c0370c3b4d3376daf8fe110e7d8cb4930ba433e606a53f4f283f02dddeb6d51b0dc3e463629b14a27995de9c71eca01000000ba08000000010020b1b547956a0dfb7ea618231563b3acd23607586e939f88e5a6db5f392b2e78d500000000690000000800000061000000100000001800000061000000c561436317000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d0c0000000800000000000000ce0000000c0000006d0000006100000010000000180000006100000000e8764817000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d61000000100000001800000061000000e91c708e17000000490000001000000030000000310000009bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce80114000000e5260d839a786ac2a909181df9a423f1efbe863d1c0000000c0000001800000008000000deadbeefdeadbeef00000000140000000c000000100000000000000000000000 --expectReject
  [ "$status" -eq 0 ]
  grep -q "<= b''6982" <(echo "$output")
  rejectionMessageCheck "Data found in non-dao cell"
}
